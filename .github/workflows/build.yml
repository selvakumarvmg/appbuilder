name: Build PremediaApp Windows Installer

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          echo === Installing Python Packages ===
          if not exist requirements.txt (
            echo ERROR: requirements.txt not found!
            dir
            exit 1
          )
          type requirements.txt
          python -m pip install --upgrade pip
          pip install -r requirements.txt pyinstaller
          pip list > installed_packages.txt
        shell: cmd

      - name: Verify Installed Packages
        run: |
          echo === Installed Packages ===
          type installed_packages.txt
        shell: cmd

      - name: Verify Key Files
        run: |
          echo === Verifying Files ===
          if not exist app.py (
            echo ERROR: app.py not found!
            exit 1
          )
          if not exist app.spec (
            echo ERROR: app.spec not found!
            exit 1
          )
          if not exist login.py (
            echo ERROR: login.py not found!
            exit 1
          )
        shell: cmd

      - name: Compile Python Code (Check Syntax Errors)
        run: |
          echo === Checking Syntax ===
          python -m py_compile app.py
          python -m py_compile login.py
        shell: cmd

      - name: Run PyInstaller (onedir for fast startup)
        run: |
          echo === Running PyInstaller ===
          pyinstaller --noconfirm app.spec > pyinstaller.log 2>&1
          if %errorlevel% neq 0 (
            echo ERROR: PyInstaller failed!
            type pyinstaller.log
            exit 1
          )
          echo === PyInstaller Finished Successfully ===
        shell: cmd

      - name: Upload PyInstaller Log
        uses: actions/upload-artifact@v4
        with:
          name: pyinstaller-log-windows
          path: pyinstaller.log
        if: always()

      - name: Check Build Output
        run: |
          echo === Checking dist/PremediaApp Output ===
          dir dist
          dir dist\PremediaApp
          if not exist dist\PremediaApp\PremediaApp.exe (
            echo ERROR: EXE not found in dist\PremediaApp!
            exit 1
          )
        shell: cmd

      - name: Setup Inno Setup
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.2
        with:
          path: installer/installer.iss

      - name: Verify Inno Setup Output
        run: |
          echo === Checking Inno Setup Output ===
          dir Output
          if not exist Output\PremediaApp-Setup.exe (
            echo ERROR: PremediaApp-Setup.exe not found!
            dir Output
            exit 1
          )
        shell: cmd
        if: always()

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Installer
          path: Output/PremediaApp-Setup.exe
        if: always()
