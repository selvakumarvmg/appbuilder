name: Build and Package Notifier App

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build_windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.10

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r dev-requirements.txt pyinstaller

    - name: Build Windows executable
      run: |
        pyinstaller --onefile --windowed --icon=pm.ico --name=notifier app.py

    - name: Upload Windows executable artifact
      uses: actions/upload-artifact@v3
      with:
        name: notifier-windows-exe
        path: dist/notifier.exe

  build_ubuntu:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.10

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip fakeroot dpkg-dev
        python3 -m pip install --upgrade pip
        pip install -r dev-requirements.txt pyinstaller

    - name: Build Linux executable
      run: |
        pyinstaller --onefile --windowed --icon=pm.ico --name=notifier app.py

    - name: Create Debian package structure
      run: |
        mkdir -p package/DEBIAN
        mkdir -p package/usr/local/bin

        # Control file metadata for .deb
        cat > package/DEBIAN/control <<EOF
Package: notifier
Version: 1.0.0
Section: utils
Priority: optional
Architecture: amd64
Maintainer: Your Name <you@example.com>
Description: Notifier app built with PySide6
EOF

        # Copy binary
        cp dist/notifier package/usr/local/bin/notifier

        # Set permissions
        chmod 755 package/usr/local/bin/notifier

    - name: Build .deb package
      run: |
        dpkg-deb --build package notifier_1.0.0_amd64.deb

    - name: Upload Ubuntu .deb package
      uses: actions/upload-artifact@v3
      with:
        name: notifier-ubuntu-deb
        path: notifier_1.0.0_amd64.deb

  build_macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.10

    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip3 install -r dev-requirements.txt pyinstaller

    - name: Build macOS app bundle
      run: |
        pyinstaller --windowed --name notifier --icon pm.ico app.py

    - name: Upload macOS app bundle
      uses: actions/upload-artifact@v3
      with:
        name: notifier-macos-app
        path: dist/notifier.app

