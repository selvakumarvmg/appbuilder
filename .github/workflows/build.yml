name: PremediaApp Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Install additional dependencies for Ubuntu
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libegl1-mesa-dev libgl1-mesa-glx desktop-file-utils dpkg-dev

    - name: Build executable
      run: |
        pyinstaller --noconfirm --onefile \
          --add-data "icons${{ matrix.os == 'windows-latest' && ';' || ':' }}icons" \
          --add-data "terms.txt${{ matrix.os == 'windows-latest' && ';' || ':' }}." \
          --add-data "license.txt${{ matrix.os == 'windows-latest' && ';' || ':' }}." \
          --icon icons/premedia.${{ matrix.os == 'windows-latest' && 'ico' || matrix.os == 'macos-latest' && 'icns' || 'png' }} \
          --name PremediaApp main.py

    - name: Package macOS app bundle
      if: matrix.os == 'macos-latest'
      run: |
        mkdir -p dist/PremediaApp.app/Contents/MacOS
        mkdir -p dist/PremediaApp.app/Contents/Resources
        mv dist/PremediaApp dist/PremediaApp.app/Contents/MacOS/PremediaApp
        mv dist/icons dist/PremediaApp.app/Contents/Resources/icons
        mv dist/terms.txt dist/PremediaApp.app/Contents/Resources/
        mv dist/license.txt dist/PremediaApp.app/Contents/Resources/
        echo '<?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>PremediaApp</string>
            <key>CFBundleIconFile</key>
            <string>premedia.icns</string>
            <key>CFBundleIdentifier</key>
            <string>com.xai.PremediaApp</string>
            <key>CFBundleName</key>
            <string>PremediaApp</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>CFBundleURLTypes</key>
            <array>
                <dict>
                    <key>CFBundleURLName</key>
                    <string>com.xai.PremediaApp</string>
                    <key>CFBundleURLSchemes</key>
                    <array>
                        <string>premediaapp</string>
                    </array>
                </dict>
            </array>
        </dict>
        </plist>' > dist/PremediaApp.app/Contents/Info.plist
        hdiutil create -volname "PremediaApp" -srcfolder dist/PremediaApp.app -ov -format UDZO dist/PremediaApp.dmg

    - name: Package Windows installer
      if: matrix.os == 'windows-latest'
      run: |
        iscc installer.iss
      env:
        ISCC_PATH: "C:\\Program Files (x86)\\Inno Setup 6\\ISCC.exe"

    - name: Package Ubuntu .deb
      if: matrix.os == 'ubuntu-latest'
      run: |
        # Create directory structure for .deb package
        mkdir -p deb-package/DEBIAN
        mkdir -p deb-package/opt/PremediaApp
        mkdir -p deb-package/usr/share/applications
        mkdir -p deb-package/usr/share/icons/hicolor/scalable/apps
        mkdir -p deb-package/usr/share/mime/packages

        # Copy PyInstaller output to package directory
        cp dist/PremediaApp deb-package/opt/PremediaApp/
        cp -r dist/icons deb-package/opt/PremediaApp/
        cp dist/terms.txt deb-package/opt/PremediaApp/
        cp dist/license.txt deb-package/opt/PremediaApp/
        chmod -R 755 deb-package/opt/PremediaApp

        # Create .desktop files
        cat > deb-package/usr/share/applications/premediaapp.desktop << EOL
        [Desktop Entry]
        Name=PremediaApp
        Comment=Image Retouching Application
        Exec=/opt/PremediaApp/PremediaApp %u
        Type=Application
        Terminal=false
        Icon=/opt/PremediaApp/icons/premedia.png
        Categories=Utility;Graphics;
        MimeType=x-scheme-handler/premediaapp;
        EOL

        cat > deb-package/usr/share/applications/premediaapp-terms.desktop << EOL
        [Desktop Entry]
        Name=PremediaApp Terms
        Comment=View PremediaApp Terms of Service
        Exec=xdg-open /opt/PremediaApp/terms.txt
        Type=Application
        Terminal=false
        Icon=/opt/PremediaApp/icons/premedia.png
        Categories=Utility;
        EOL

        cat > deb-package/usr/share/applications/premediaapp-license.desktop << EOL
        [Desktop Entry]
        Name=PremediaApp License
        Comment=View PremediaApp License
        Exec=xdg-open /opt/PremediaApp/license.txt
        Type=Application
        Terminal=false
        Icon=/opt/PremediaApp/icons/premedia.png
        Categories=Utility;
        EOL

        # Create MIME type for custom URL scheme
        cat > deb-package/usr/share/mime/packages/premediaapp.xml << EOL
        <?xml version="1.0" encoding="UTF-8"?>
        <mime-info xmlns="http://www.freedesktop.org/standards/shared-mime-info">
          <mime-type type="x-scheme-handler/premediaapp">
            <comment>PremediaApp URL</comment>
            <glob pattern="premediaapp:*"/>
          </mime-type>
        </mime-info>
        EOL

        # Copy icon to standard location
        cp dist/icons/premedia.png deb-package/usr/share/icons/hicolor/scalable/apps/

        # Create DEBIAN/control file
        cat > deb-package/DEBIAN/control << EOL
        Package: premediaapp
        Version: 1.0.0
        Architecture: all
        Maintainer: Your Name <your.email@example.com>
        Depends: python3 (>= 3.9), libegl1-mesa, libgl1-mesa-glx
        Section: utils
        Priority: optional
        Homepage: https://example.com
        Description: PremediaApp Image Retouching Application
         Premedia+aApp is a cross-platform application for image retouching.
        EOL

        # Create post-install script to update MIME and desktop databases
        cat > deb-package/DEBIAN/postinst << EOL
        #!/bin/sh
        set -e
        update-mime-database /usr/share/mime
        update-desktop-database
        xdg-mime default premediaapp.desktop x-scheme-handler/premediaapp
        EOL
        chmod 755 deb-package/DEBIAN/postinst

        # Build the .deb package
        dpkg-deb --build deb-package dist/premediaapp_1.0.0_all.deb

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: PremediaApp-${{ matrix.os }}-${{ matrix.python-version }}
        path: |
          dist/premediaapp_1.0.0_all.deb
          dist/*.dmg
          Output/*.exe

    - name: Run tests
      run: |
        pip install -r dev-requirements.txt
        pytest --cov=./ --cov-report=xml