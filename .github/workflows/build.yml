name: Build PremediaApp

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  APP_NAME: PremediaApp
  APP_VERSION: 1.0.0
  PUBLISHER: "VMG DIGITAL PVT LTD"
  PUBLISHER_EMAIL: "admin@vmgdigital.com"
  PRIVACY_POLICY: "https://create.vmgdigital.com/privacy-policy.html"
  SUPPORT_EMAIL: "admin@vmgdigital.com"
  SUPPORT_INFO: "Support included"
  LICENSE_TYPE: "Free License"
  JURISDICTION: "Laws of India"
  CONTACT_INFO: "24, 25 & 26, Taylors Rd, Kilpauk, Chennai, Tamil Nadu 600010"

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Build Windows EXE with PyInstaller
        run: |
          pyinstaller --onefile --windowed --icon=pm.ico --name=PremediaApp app.py
          echo "=== Listing dist directory ==="
          dir dist
        shell: cmd

      - name: Download and Install Inno Setup
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://jrsoftware.org/download.php/is.exe" -OutFile "is.exe"
          Start-Process .\is.exe -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/SP-" -Wait
          Write-Host "Inno Setup Installed"

      - name: Create Inno Setup Script
        shell: cmd
        run: |
          echo [Setup] > installer.iss
          echo AppName=PremediaApp >> installer.iss
          echo AppVersion=1.0.0 >> installer.iss
          echo AppPublisher=VMG DIGITAL PVT LTD >> installer.iss
          echo AppPublisherURL=https://vmgdigital.com >> installer.iss
          echo AppSupportURL=https://vmgdigital.com/support >> installer.iss
          echo DefaultDirName={pf}\PremediaApp >> installer.iss
          echo DefaultGroupName=PremediaApp >> installer.iss
          echo OutputBaseFilename=PremediaApp_Setup_1.0.0 >> installer.iss
          echo Compression=lzma >> installer.iss
          echo SolidCompression=yes >> installer.iss
          echo [Files] >> installer.iss
          echo Source: "dist\PremediaApp.exe"; DestDir: "{app}"; Flags: ignoreversion >> installer.iss
          echo [Icons] >> installer.iss
          echo Name: "{group}\PremediaApp"; Filename: "{app}\PremediaApp.exe" >> installer.iss
          echo [Run] >> installer.iss
          echo Filename: "{app}\PremediaApp.exe"; Description: "Launch PremediaApp"; Flags: nowait postinstall skipifsilent >> installer.iss
          echo Installer Script Created

      - name: Run Inno Setup Compiler (ISCC)
        run: '"C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss'
        shell: cmd

      - name: List Output Files
        run: dir
        shell: cmd

      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: premediaapp-windows
          path: PremediaApp_Setup_1.0.0.exe

  build-ubuntu:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y dpkg-dev fakeroot
          pip install pyinstaller

      - name: Build binary
        run: |
          pyinstaller --onefile --windowed --icon=pm.png --name=PremediaApp app.py
          ls dist

      - name: Create Debian package
        run: |
          mkdir -p package/DEBIAN
          mkdir -p package/usr/local/bin
          echo "Package: premediaapp" > package/DEBIAN/control
          echo "Version: 1.0.0" >> package/DEBIAN/control
          echo "Section: utils" >> package/DEBIAN/control
          echo "Priority: optional" >> package/DEBIAN/control
          echo "Architecture: amd64" >> package/DEBIAN/control
          echo "Maintainer: ${PUBLISHER} <${PUBLISHER_EMAIL}>" >> package/DEBIAN/control
          echo "Description: Premedia app built with PySide6" >> package/DEBIAN/control
          echo "License: ${LICENSE_TYPE}" >> package/DEBIAN/control
          echo "Homepage: https://vmgdigital.com" >> package/DEBIAN/control
          cp dist/PremediaApp package/usr/local/bin/PremediaApp
          chmod 755 package/usr/local/bin/PremediaApp
          dpkg-deb --build package
          mv package.deb premediaapp_1.0.0_amd64.deb

      - name: Upload .deb package
        uses: actions/upload-artifact@v4
        with:
          name: premediaapp-ubuntu
          path: premediaapp_1.0.0_amd64.deb

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install pyinstaller

      - name: Build macOS binary
        run: |
          pyinstaller --onefile --windowed --icon=pm.icns --name=PremediaApp app.py
          ls dist

      - name: Create DMG
        run: |
          mkdir -p PremediaApp.app/Contents/MacOS
          cp dist/PremediaApp PremediaApp.app/Contents/MacOS/PremediaApp
          hdiutil create -volname "PremediaApp" -srcfolder PremediaApp.app -ov -format UDZO PremediaApp_1.0.0.dmg

      - name: Upload macOS .dmg
        uses: actions/upload-artifact@v4
        with:
          name: premediaapp-macos
          path: PremediaApp_1.0.0.dmg
