name: PremediaApp Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt || echo "Failed to install requirements.txt"
        else
          echo "requirements.txt not found"
        fi
        pip install pyinstaller
      continue-on-error: true

    - name: Install additional dependencies for Ubuntu
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libegl1-mesa-dev libgl1-mesa-glx desktop-file-utils dpkg-dev
      continue-on-error: true

    - name: Verify required files
      run: |
        echo "Checking required files..."
        ls -l app.py || echo "app.py not found"
        ls -l requirements.txt || echo "requirements.txt not found"
        ls -l icons/premedia.png || echo "icons/premedia.png not found"
        ls -l icons/premedia.ico || echo "icons/premedia.ico not found"
        ls -l icons/premedia.icns || echo "icons/premedia.icns not found"
        ls -l terms.txt || echo "terms.txt not found"
        ls -l license.txt || echo "license.txt not found"
      continue-on-error: true

    - name: Build executable
      run: |
        pyinstaller --noconfirm --onefile \
          --add-data "icons${{ matrix.os == 'windows-latest' && ';' || ':' }}icons" \
          --add-data "terms.txt${{ matrix.os == 'windows-latest' && ';' || ':' }}." \
          --add-data "license.txt${{ matrix.os == 'windows-latest' && ';' || ':' }}." \
          --icon icons/premedia.${{ matrix.os == 'windows-latest' && 'ico' || matrix.os == 'macos-latest' && 'icns' || 'png' }} \
          --name PremediaApp app.py || echo "PyInstaller failed"
      continue-on-error: true

    - name: Package macOS app bundle
      if: matrix.os == 'macos-latest'
      run: |
        mkdir -p dist/PremediaApp.app/Contents/MacOS
        mkdir -p dist/PremediaApp.app/Contents/Resources
        mv dist/PremediaApp dist/PremediaApp.app/Contents/MacOS/PremediaApp || echo "Failed to move PremediaApp"
        mv dist/icons dist/PremediaApp.app/Contents/Resources/icons || echo "Failed to move icons"
        mv dist/terms.txt dist/PremediaApp.app/Contents/Resources/ || echo "Failed to move terms.txt"
        mv dist/license.txt dist/PremediaApp.app/Contents/Resources/ || echo "Failed to move license.txt"
        echo '<?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>PremediaApp</string>
            <key>CFBundleIconFile</key>
            <string>premedia.icns</string>
            <key>CFBundleIdentifier</key>
            <string>com.xai.PremediaApp</string>
            <key>CFBundleName</key>
            <string>PremediaApp</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>NSHighResolutionCapable</key>
            <true/>
        </dict>
        </plist>' > dist/PremediaApp.app/Contents/Info.plist
        hdiutil create -volname "PremediaApp" -srcfolder dist/PremediaApp.app -ov -format UDZO dist/PremediaApp.dmg || echo "Failed to create DMG"
      continue-on-error: true

    - name: Package Windows installer
      if: matrix.os == 'windows-latest'
      run: |
        if [ -f installer.iss ]; then
          iscc installer.iss || echo "Inno Setup failed"
        else
          echo "installer.iss not found"
        fi
      env:
        ISCC_PATH: "C:\\Program Files (x86)\\Inno Setup 6\\ISCC.exe"
      continue-on-error: true

    - name: Package Ubuntu .deb
      if: matrix.os == 'ubuntu-latest'
      run: |
        # Create directory structure for .deb package
        mkdir -p deb-package/DEBIAN
        mkdir -p deb-package/opt/PremediaApp
        mkdir -p deb-package/usr/share/applications
        mkdir -p deb-package/usr/share/icons/hicolor/scalable/apps

        # Copy PyInstaller output to package directory
        cp dist/PremediaApp deb-package/opt/PremediaApp/ || echo "Failed to copy PremediaApp"
        cp -r dist/icons deb-package/opt/PremediaApp/ || echo "Failed to copy icons"
        cp dist/terms.txt deb-package/opt/PremediaApp/ || echo "Failed to copy terms.txt"
        cp dist/license.txt deb-package/opt/PremediaApp/ || echo "Failed to copy license.txt"
        chmod -R 755 deb-package/opt/PremediaApp

        # Debug: Check executable
        file deb-package/opt/PremediaApp/PremediaApp || echo "Executable not found"
        ldd deb-package/opt/PremediaApp/PremediaApp || echo "ldd check failed"

        # Create .desktop files
        cat > deb-package/usr/share/applications/premediaapp.desktop << EOL
        [Desktop Entry]
        Name=PremediaApp
        Comment=Image Retouching Application
        Exec=/opt/PremediaApp/PremediaApp
        Type=Application
        Terminal=false
        Icon=premedia
        Categories=Utility;Graphics;
        EOL

        cat > deb-package/usr/share/applications/premediaapp-terms.desktop << EOL
        [Desktop Entry]
        Name=PremediaApp Terms
        Comment=View PremediaApp Terms of Service
        Exec=xdg-open /opt/PremediaApp/terms.txt
        Type=Application
        Terminal=false
        Icon=premedia
        Categories=Utility;
        EOL

        cat > deb-package/usr/share/applications/premediaapp-license.desktop << EOL
        [Desktop Entry]
        Name=PremediaApp License
        Comment=View PremediaApp License
        Exec=xdg-open /opt/PremediaApp/license.txt
        Type=Application
        Terminal=false
        Icon=premedia
        Categories=Utility;
        EOL

        # Copy icon to standard location
        cp dist/icons/premedia.png deb-package/usr/share/icons/hicolor/scalable/apps/premedia.png || echo "Failed to copy icon"

        # Create DEBIAN/control file
        cat > deb-package/DEBIAN/control << EOL
        Package: premediaapp
        Version: 1.0.0
        Architecture: all
        Maintainer: Your Name <your.email@example.com>
        Depends: python3 (>= 3.9), libegl1-mesa, libgl1-mesa-glx
        Section: utils
        Priority: optional
        Homepage: https://example.com
        Description: PremediaApp Image Retouching Application
         PremediaApp is a cross-platform application for image retouching.
        EOL

        # Create post-install script
        cat > deb-package/DEBIAN/postinst << EOL
        #!/bin/sh
        set -e
        update-desktop-database
        gtk-update-icon-cache /usr/share/icons/hicolor || true
        EOL
        chmod 755 deb-package/DEBIAN/postinst

        # Build the .deb package
        dpkg-deb --build deb-package dist/premediaapp_1.0.0_all.deb || echo "Failed to build .deb package"
      continue-on-error: true

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: PremediaApp-${{ matrix.os }}-${{ matrix.python-version }}
        path: |
          dist/premediaapp_1.0.0_all.deb
          dist/*.dmg
          Output/*.exe
      continue-on-error: true

    - name: Run tests
      run: |
        if [ -f dev-requirements.txt ]; then
          pip install -r dev-requirements.txt || echo "Failed to install dev-requirements.txt"
          pytest --cov=./ --cov-report=xml || echo "Tests failed"
        else
          echo "dev-requirements.txt not found"
        fi
      continue-on-error: true