name: Build macOS DMG for PremediaApp

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-14

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: ğŸ“¦ Install Build Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller PySide6 dmgbuild

      - name: ğŸ§ª Verify Python and Tools
        run: |
          echo "ğŸ Python version: $(python --version)"
          echo "ğŸ“¦ PyInstaller version: $(pyinstaller --version)"
          echo "ğŸ§­ dmgbuild path: $(which dmgbuild)"
          python -c "import PySide6; print('âœ… PySide6:', PySide6.__version__)"
          python -c "import PIL; print('âœ… Pillow:', PIL.__version__)"

      - name: ğŸ“‚ List Project Files
        run: |
          echo "ğŸ“ Working directory: $(pwd)"
          find . -type f | sort

      - name: ğŸ§¹ Clean PyInstaller Cache
        run: |
          echo "ğŸ§¼ Cleaning build directories..."
          rm -rf build dist __pycache__
          rm -rf ~/Library/Application\ Support/pyinstaller
          ls -la

      - name: ğŸ” Validate Spec File
        run: |
          echo "ğŸ“„ Preview app.spec:"
          cat app.spec
          echo "ğŸ” Compiling spec..."
          python -m py_compile app.spec || exit 1

      - name: ğŸš§ Run PyInstaller Build (Debug Mode)
        run: |
          echo "ğŸš€ Building with PyInstaller..."
          pyinstaller --clean --noconfirm app.spec --log-level=DEBUG > pyinstaller.log 2>&1 || {
            echo "âŒ PyInstaller failed!"
            tail -n 50 pyinstaller.log
            exit 1
          }
          echo "âœ… PyInstaller build finished."
          ls -lh dist

      - name: ğŸ§¼ Fix Code Signature & Quarantine
        run: |
          echo "ğŸ§¹ Cleaning quarantine flags..."
          rm -rf dist/PremediaApp.app/Contents/_CodeSignature || true
          xattr -rd com.apple.quarantine dist/PremediaApp.app || true

      - name: ğŸ“¦ Prepare DMG Contents
        run: |
          mkdir -p dmg-build
          cp -R dist/PremediaApp.app dmg-build/
          echo "ğŸ“ dmg-build:"
          ls -lh dmg-build/

      - name: ğŸ’½ Build DMG with dmgbuild
        run: |
          echo "ğŸ–¼ï¸ Background image check:"
          file installer-assets/dmg-background.bmp
          echo "ğŸ“¦ Building DMG..."
          dmgbuild -s installer/dmg-settings.py \
                   "PremediaApp" \
                   "dmg-build/PremediaApp.dmg" > hdiutil.log 2>&1 || {
              echo "âŒ dmgbuild failed!"
              tail -n 50 hdiutil.log
              exit 1
          }
          echo "âœ… DMG build complete!"
          ls -lh dmg-build/

      - name: ğŸ“¤ Upload DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PremediaApp-macos-dmg
          path: dmg-build/PremediaApp.dmg

      - name: ğŸ“„ Upload Logs for Debugging
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            pyinstaller.log
            hdiutil.log
