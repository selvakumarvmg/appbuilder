name: Build Python Desktop App with Docker

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build Docker image and run PyInstaller build
        run: |
          # Build a Docker image with Python and PyInstaller installed
          cat <<EOF > Dockerfile
          FROM ubuntu:22.04

          RUN apt-get update && apt-get install -y python3.10 python3-pip python3.10-venv build-essential

          WORKDIR /app

          COPY . /app

          RUN python3.10 -m pip install --upgrade pip
          RUN python3.10 -m pip install pyinstaller PySide6 requests

          RUN python3.10 -m PyInstaller --noconfirm --windowed --onefile --icon=pm.png --name=PremediaApp app.py

          EOF

          docker build -t premediaapp-build .

          # Create container and copy out the built app binary
          container_id=$(docker create premediaapp-build)
          docker cp $container_id:/app/dist/PremediaApp ./PremediaApp
          docker rm $container_id

      - name: List built files
        run: ls -l

      - name: Upload built executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: PremediaApp-Binary
          path: PremediaApp
