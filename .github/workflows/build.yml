name: Build PremediaApp

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  APP_NAME: PremediaApp
  APP_VERSION: 1.0.0
  PUBLISHER: "VMG DIGITAL PVT LTD"
  PUBLISHER_EMAIL: "admin@vmgdigita.com"
  PRIVACY_POLICY: "https://create.vmgdigital.com/privacy-policy.html"
  SUPPORT_EMAIL: "admin@vmgdigita.com"
  SUPPORT_INFO: "Support included"
  LICENSE_TYPE: "Free License"
  JURISDICTION: "Laws of India"
  CONTACT_INFO: "24, 25 & 26, Taylors Rd, Kilpauk, Chennai, Tamil Nadu 600010"

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Build Windows executable
        run: |
          pyinstaller --onefile --windowed --icon=pm.ico --name=${{ env.APP_NAME }} app.py

      - name: Install Inno Setup
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://jrsoftware.org/download.php/is.exe" -OutFile "is.exe"
          Start-Process -FilePath .\is.exe -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/SP-" -Wait

      - name: Create Inno Setup script
        shell: pwsh
        run: |
          $content = @"
          [Setup]
          AppName=${{ env.APP_NAME }}
          AppVersion=${{ env.APP_VERSION }}
          AppPublisher=${{ env.PUBLISHER }}
          AppPublisherURL=https://vmgdigital.com
          AppSupportURL=${{ env.PRIVACY_POLICY }}
          AppContact=${{ env.CONTACT_INFO }}
          DefaultDirName={pf}\${{ env.APP_NAME }}
          DefaultGroupName=${{ env.APP_NAME }}
          OutputBaseFilename=${{ env.APP_NAME }}_Setup_${{ env.APP_VERSION }}
          SetupIconFile=pm.ico
          Compression=lzma
          SolidCompression=yes
          LicenseFile=LICENSE.txt
          InfoBeforeFile=TERMS.txt

          [Languages]
          Name: "english"; MessagesFile: "compiler:Default.isl"

          [Tasks]
          Name: "desktopicon"; Description: "Create a &desktop icon"; GroupDescription: "Additional icons:"; Flags: unchecked

          [Files]
          Source: "dist\${{ env.APP_NAME }}.exe"; DestDir: "{app}"; Flags: ignoreversion

          [Icons]
          Name: "{group}\${{ env.APP_NAME }}"; Filename: "{app}\${{ env.APP_NAME }}.exe"
          Name: "{commondesktop}\${{ env.APP_NAME }}"; Filename: "{app}\${{ env.APP_NAME }}.exe"; Tasks: desktopicon

          [Run]
          Filename: "{app}\${{ env.APP_NAME }}.exe"; Description: "Launch ${{ env.APP_NAME }}"; Flags: nowait postinstall skipifsilent
          "@
          $content | Set-Content -Path installer.iss

      - name: Build Windows Installer
        shell: pwsh
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss

      - name: List files before upload
        run: dir

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: premediaapp-windows-installer
          path: ${{ env.APP_NAME }}_Setup_${{ env.APP_VERSION }}.exe
