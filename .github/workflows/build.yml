name: Build PremediaApp macOS DMG

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-14

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Install Xcode CLI tools
        run: |
          if ! xcode-select -p; then
            sudo xcode-select --install
          fi

      - name: ğŸ Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: ğŸ“¦ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller PySide6 dmgbuild

      - name: ğŸ§ª Verify Installed Packages
        run: |
          echo "ğŸ Python: $(python --version)"
          echo "ğŸ“¦ PyInstaller: $(pyinstaller --version)"
          python -c "import PySide6; print('âœ… PySide6:', PySide6.__version__)"
          python -c "import PIL; print('âœ… Pillow:', PIL.__version__)"
          echo "ğŸ§­ dmgbuild: $(which dmgbuild)"
          dmgbuild -h | head -n 10

      - name: ğŸ› ï¸ Compile PyInstaller Spec File
        run: |
          echo "ğŸ” Verifying spec file..."
          python -m py_compile PremediaApp.spec

      - name: ğŸš§ Build App with PyInstaller
        run: |
          echo "ğŸš§ Starting PyInstaller build..."
          pyinstaller --clean --noconfirm PremediaApp.spec --log-level DEBUG > pyinstaller.log 2>&1 || {
            echo "âŒ PyInstaller build failed!"
            tail -n 50 pyinstaller.log
            exit 1
          }

      - name: ğŸ” Inspect .app Bundle Contents
        run: |
          echo "ğŸ“¦ Size of PremediaApp.app:"
          du -sh dist/PremediaApp.app || true

          echo "ğŸ“‚ Files in PremediaApp.app:"
          find dist/PremediaApp.app -type f | head -n 50

          echo "ğŸ“‹ Contents of Info.plist:"
          plutil -p dist/PremediaApp.app/Contents/Info.plist || echo "Info.plist not found"

      - name: ğŸ§¹ Clean Code Signature & Quarantine Flags
        run: |
          echo "ğŸ§¹ Cleaning code signature and quarantine attributes..."
          rm -rf dist/PremediaApp.app/Contents/_CodeSignature || true
          xattr -rd com.apple.quarantine dist/PremediaApp.app || true

      - name: ğŸ” Validate DMG Inputs
        run: |
          echo "ğŸ–¼ï¸ Validating background image:"
          file installer-assets/dmg-background.bmp || {
            echo "âŒ Background image missing or invalid!"
            exit 1
          }

          echo "ğŸ“‚ Validating .app exists:"
          ls -lh dist/PremediaApp.app || {
            echo "âŒ .app bundle not found!"
            exit 1
          }

          echo "ğŸ“„ Showing dmg-settings.py:"
          cat installer/dmg-settings.py

      - name: ğŸ’½ Build DMG with dmgbuild
        run: |
          echo "ğŸ“¦ Preparing dmg-build folder..."
          mkdir -p dmg-build
          cp -R dist/PremediaApp.app dmg-build/

          echo "ğŸ“ Contents of dmg-build:"
          ls -lh dmg-build/

          echo "ğŸ’½ Running dmgbuild..."
          dmgbuild -s installer/dmg-settings.py \
                   "PremediaApp" \
                   "dmg-build/PremediaApp.dmg" > hdiutil.log 2>&1 || {
                      echo "âŒ dmgbuild failed!"
                      tail -n 30 hdiutil.log
                      exit 1
                   }

      - name: ğŸ“¦ Inspect Final DMG
        run: |
          echo "ğŸ“¦ Final .dmg size and contents:"
          ls -lh dmg-build/
          hdiutil imageinfo dmg-build/PremediaApp.dmg || echo "âš ï¸ Unable to inspect .dmg"

      - name: ğŸ“¤ Upload DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PremediaApp-macos-dmg
          path: dmg-build/PremediaApp.dmg

      - name: ğŸ“¤ Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-extreme-debug-logs
          path: |
            pyinstaller.log
            hdiutil.log
